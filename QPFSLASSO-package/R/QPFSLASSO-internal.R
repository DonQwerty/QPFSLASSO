.fill_mat <-
function(x,y,summary,g){
    abs(summary$median[paste(x,0),g]-summary$median[paste(y,0),g])/
      (summary$mad[paste(x,0),g]+summary$mad[paste(y,0),g]+1)
  }
.fill_vector <-
function(c,summary,g){
    abs(summary$median[paste(c,0),g]-summary$median[paste(c,1),g])/
      (summary$mad[paste(c,0),g]+summary$mad[paste(c,1),g]+1)
  }
.getAlpha <-
function(summary,condition,genes,no_cores=NULL){
    if(is.null(no_cores))
      no_cores <- detectCores() - 1
    cl <- makeCluster(no_cores)
    #sumas<-sapply(genes,.redundancy_aux,summary=summary,condition=unique(condition),genes=genes,f1=.fill_mat,f2=.fill_vector,entropy=entropy)
    sumas<-pbsapply(genes,FUN=.redundancy_aux,summary=summary,conditions=as.character(unique(condition)),
                    genes=genes,f1=.fill_mat,f2=.fill_vector,entropy=entropy,cl = cl)
    stopCluster(cl)
    sumas<-apply(sumas,1,sum)
    Qa<-sumas[1]
    qa<-sumas[2]
    alpha<-Qa/(Qa+abs(qa))
    print(paste("Alpha's value:",alpha))
    return(alpha)
  }
.getSummary <-
function(x){
    parent.env(environment(data.table))
    library(data.table)
    x<-data.table(x)
    summ<- x[,.(median=sapply(.SD,median)),by=c("control","condition"),.SDcols = 1:(ncol(x)-2)]
    summ$gen<-rep(names(x)[1:(length(x)-2)],length(unique(x$control))*length(unique(x$condition)))
    median_data<-as.data.frame(dcast(summ,condition + control ~ gen,value.var = "median"))
    rownames(median_data)<-paste(median_data$condition,median_data$control)
    
    summ<- x[,.(mad=sapply(.SD,mad)),by=c("control","condition"),.SDcols = 1:(ncol(x)-2)]
    summ$gen<-rep(names(x)[1:(length(x)-2)],length(unique(x$control))*length(unique(x$condition)))
    mad_data<-as.data.frame(dcast(summ,condition + control ~ gen,value.var = "mad"))
    rownames(mad_data)<-paste(mad_data$condition,mad_data$control)
    
    l<-list(median=median_data,mad=mad_data)
    return(l)
  }
.get_weight <-
function(g,summary,conditions,genes,f1,f2,f3,entropy,alpha,lambda){
    
    g<-as.character(g)
    m_Q<-outer(conditions,conditions,FUN=f1,summary=summary,g=g)
    
    v<-sapply(conditions,FUN=f2,summary=summary,g=g)
    en<-entropy(v/sum(v))
    if(is.na(en))
      en<-999
    en<-tanh(en)
    mat_entropy<-matrix(rep(en,length(v)**2),length(v),length(v))
    diag(mat_entropy)<-length(conditions)
    m_Q<- 1-tanh(m_Q)
    diag(m_Q)<-length(conditions)
    v<-tanh(v)
    a<-f3((m_Q+mat_entropy)*(1-alpha),v*alpha+rep(-lambda,length(conditions)),diag(length(conditions)))$solution
    print(paste(g,genes[g]))
    names(a)<- paste(rep(genes[g],length(conditions)),conditions,sep="_")
    return(a)
  }
.obtein_weight <-
function(gen,ruta,alpha){
    system(paste0("sh ",ruta,"obtenerPesos.sh ",gen," ",alpha))
  }
.Random.seed <-
c(403L, 78L, 2028046148L, -197004421L, 1360673147L, -1595760656L, 
-1022330669L, -1452792033L, 57168591L, -1170518877L, -1899578062L, 
1125860755L, 1286229309L, -227054257L, -1580184590L, 543311380L, 
2015391108L, 815315661L, 658586941L, 258498584L, 1032628858L, 
-1592703242L, 1551161281L, 1957763137L, 1562059204L, 166870271L, 
-1246435210L, 1189024257L, 1403582100L, -761791363L, 473953177L, 
-2040419498L, -496613220L, 2088094462L, 1592587235L, 34300459L, 
-1774927484L, -1826801407L, -1516973693L, -1844739077L, 16225546L, 
-2085079342L, -1178223265L, -248619347L, -1492531156L, 28587980L, 
693743471L, -1580299754L, -386658500L, 845370707L, -828059858L, 
-972181796L, -12535516L, 173238576L, -133427648L, 1213321875L, 
-1727546548L, 1411106987L, 1330989868L, 355157864L, -2026270771L, 
290508955L, 1153206538L, 489473459L, -1348697186L, -250299074L, 
1784075195L, 557007614L, -2103536477L, -401556998L, -69072012L, 
-1010862292L, 35788305L, -160232511L, -668147252L, 190375039L, 
-114696154L, 1406935844L, 1814627275L, -1045883716L, 373175340L, 
1218142200L, 985836950L, 465585726L, -86214722L, 1912909479L, 
2109006112L, 223395465L, 847999859L, -214629218L, 1110828480L, 
1253535929L, 221493175L, -2053726867L, -1671494053L, 1279372811L, 
-963439525L, 226483917L, -784021372L, -29443657L, 451557861L, 
1675770548L, 907933295L, -1674215816L, 1970229167L, -544925376L, 
-1868403256L, 266261507L, 1962742236L, 15630435L, -274006071L, 
97308120L, -58107325L, 1727554517L, 548403667L, 834879271L, -2067522287L, 
620572074L, -1671380934L, 252164501L, -349231687L, -529880403L, 
-1514424404L, -1905803548L, 1650834037L, 45758690L, -183626989L, 
-1617879010L, 164998871L, 637360004L, 1825747587L, -843410468L, 
1744247219L, 1570985028L, 22833902L, 996208053L, 1578514072L, 
-686712683L, 1662247302L, 901160690L, -1677735740L, 1037156504L, 
11420205L, -2079982766L, 1225138359L, 1773502246L, -562371395L, 
-773173680L, -1927372830L, 930744071L, 181331673L, -910619179L, 
-1058966586L, 218662542L, 1036394802L, -1434082157L, -1986433803L, 
-91316825L, -1755969586L, 1774192881L, 1971107852L, -779683516L, 
687539445L, 504774444L, 1693751540L, 1157473199L, -1206015406L, 
-134525501L, -354961903L, -1995520668L, 856054746L, 190717730L, 
-1535434515L, 880992648L, 303605276L, -1198597822L, 1087785967L, 
1914744229L, -235533126L, -1243558053L, -146026322L, 869667297L, 
1907765301L, -1743731303L, 494014837L, -864835326L, -1571511886L, 
-627366300L, -1314361081L, 1446057284L, 1362900104L, 606747938L, 
-510734963L, 52501772L, 1797659206L, -1834412744L, 1807894845L, 
-2057665980L, -1587734839L, -1616111295L, 1147477407L, -783391810L, 
-1896471517L, 344747305L, -2006418172L, 2013044082L, -1376165424L, 
1908790548L, 211020301L, 1211390617L, 2083340708L, -847889995L, 
489259661L, 22542268L, 2045498622L, 1687531172L, -2144653583L, 
1844407017L, -226144785L, 1756074984L, -1789280535L, 448898562L, 
-1375259117L, -51850159L, 1692160275L, -837793401L, 797207597L, 
-59050151L, 1829554133L, 2059621684L, -625434048L, 1372751611L, 
-2141007823L, 1893007061L, 30928407L, 877617644L, -270941489L, 
1105296421L, 623471627L, 1827471094L, 957250529L, -1959504091L, 
160947517L, 1602321151L, -2120434755L, -808934666L, 1779890636L, 
-582724188L, -401197033L, -1929060007L, -616670770L, 1179600734L, 
1755044429L, 1340065194L, -161625872L, -1261891812L, -1733832836L, 
-2074564520L, 91536035L, -172277048L, -76343149L, -220257512L, 
-569573407L, -1613489240L, -1327961058L, -712363864L, -1300143495L, 
1580899232L, 1524519412L, 2119541525L, 548361469L, 1080688177L, 
1976231782L, -1731775505L, 12557510L, 48878668L, 2028894720L, 
-4131826L, 1777678329L, 1006329098L, -1246216525L, 1516770930L, 
-348504472L, 480437154L, -23206766L, -1868451181L, 1359770660L, 
1934181819L, 1871643408L, 1065657949L, 198662414L, 56641369L, 
64957579L, 79809674L, 1045323056L, -231754494L, 990949852L, 1946084949L, 
412944493L, 900117045L, 742124062L, 2001273741L, 99823854L, 1498352089L, 
-804614955L, -1966133150L, -334211881L, 1733722114L, 1810772836L, 
1310860325L, 270459840L, -1751582819L, 895086469L, -1490630314L, 
981776327L, 2144792814L, -2119994877L, -296526196L, -445186678L, 
766741667L, -982862151L, 870848127L, 938758166L, 2003109318L, 
-1619218149L, -1091986812L, -1128150460L, -1506036005L, -1643401373L, 
-100485736L, 1464237524L, -1831965379L, -2107406776L, 650364710L, 
1379862663L, -321178401L, 692357342L, -1469555560L, -2142903837L, 
1594021177L, -1698068317L, -171735110L, 933693142L, 2098344204L, 
-1124932341L, -878139819L, -689470636L, -1775317839L, -370720893L, 
-2093202010L, 1848529822L, 3822305L, 869393229L, -425060276L, 
-869110958L, 65133291L, 27663446L, 2022306888L, 938233897L, -1350516042L, 
1424774650L, -1282357943L, 1688407286L, 1734000270L, -1465911965L, 
1572883860L, 841210837L, -75123151L, 269317587L, 209056421L, 
1814210685L, 1151198270L, 1793953092L, -673270924L, 134082446L, 
1214035382L, 2072352920L, 695412031L, -330030914L, 422883444L, 
-1572348476L, -1688480885L, -1520981846L, -2008343646L, -1172056706L, 
-1901178404L, -534292978L, 1769928695L, 1642188841L, 1497955645L, 
507700701L, -282100692L, -835488773L, 93542281L, 237253468L, 
-993592170L, 1042091404L, 353900381L, -831925083L, -1676028592L, 
-1229023442L, -1417359677L, -447991676L, 962087846L, -560873384L, 
1754346317L, -1144680121L, 2017250761L, 1935029880L, 1233906494L, 
-1008003837L, -1525052999L, 597556052L, 1448648489L, 781958434L, 
1544565913L, -566588436L, -1321600061L, 1949426320L, -25642448L, 
-429964674L, -1375023270L, 90691336L, -1566570269L, -1655547905L, 
433690820L, 1441556311L, 1239056561L, -1189685535L, -1183295857L, 
1960411860L, -1315512283L, -400634013L, 1619783410L, 1499767764L, 
-1252908819L, -1451854748L, 174532006L, 1989159288L, -141043381L, 
-638329413L, 1133859778L, 913466071L, 299940468L, -1450158106L, 
425813691L, 1881411278L, -169291955L, -1547173187L, 393896930L, 
-2120987199L, 647349408L, 1235000820L, 971440730L, -1120347449L, 
776882132L, 1942735381L, 1816376600L, -1831448625L, 372099405L, 
545014955L, 502834676L, 1231366831L, -1146267944L, 354150880L, 
-1395937384L, -1378284551L, 1073172698L, -857736492L, -867666208L, 
-1192840564L, 1171631933L, 785357796L, 1151189852L, -680947410L, 
-1115127601L, -1411497412L, -394863664L, 69657432L, -1610550992L, 
-1023101221L, -1463526065L, 1109502248L, -1116786279L, 946229058L, 
-1660166097L, -1753085551L, -584400525L, -2039787927L, 402274153L, 
-1507570113L, 2033031326L, 1295563429L, -78183511L, 598986814L, 
1363116633L, 1829130504L, 427374095L, 419727356L, -522367228L, 
1384139452L, 1934961321L, -1363527904L, 1786522869L, -251341501L, 
839659290L, -2142008406L, 725980374L, 599730067L, 735682003L, 
-838022254L, -179350104L, -1324191717L, -1070313275L, 1109858217L, 
268168383L, -1277100504L, -281169450L, -1897049292L, 976384677L, 
85417056L, 1902425583L, -1849169914L, 917541637L, -845413907L, 
341366439L, 1887726004L, -301053576L, -2049207914L, 1291396562L, 
-2021946825L, -798484332L, -224286816L, 1751336280L, -1497653899L, 
1206739570L, -1917959420L, -59263451L, 399661555L, -65001498L, 
-427338254L, 1852266623L, -392667348L, 996395357L, -564158259L, 
-1663922155L, -1842489930L, 1213957787L, 1708337126L, 1429282016L, 
1072802031L, -613093824L, 455809217L, 1201807581L, 634071144L, 
-870483169L, -93446937L, 86588123L, -1639419367L, -1742547308L, 
185080420L, 1357414298L, -340080707L, -748733456L, -1386157037L, 
1228707108L, 413186486L, -607693321L, 2010884573L, -1597171423L, 
687156089L, 2005013881L, 1039478650L, -1786020184L, -1166182715L, 
-1256609629L, 419097474L, -1390213218L, 706081365L, -1166899608L, 
610656815L, -1333017391L, -1626091401L, 781697939L, 546247196L, 
1247882666L, 2095491155L, -674968162L, -1456166155L, 688617069L, 
460156336L, -590590760L, 751089734L, -128388736L, -376353406L, 
958139843L, 75817865L, 376583814L, -1065737839L, -346565729L, 
-1184397184L, 1447565802L, -341201154L, 1196925516L, 1550987377L, 
-306379019L, 1430674991L, 458854965L, 696137111L, -1644400049L, 
-653339442L, -1420680239L, 1313564989L, 1359292879L, -875989374L, 
-56232076L, -1546910341L, 1129705442L, 1210108703L, -1480081510L, 
1025563170L, -1573669352L, 178992537L, -73989198L, -940876039L, 
-233236729L)
.redundancy_aux <-
function(g,summary,conditions,genes,f1,f2,entropy){
    
    g<-as.character(g)
    m_Q<-outer(conditions,conditions,FUN=f1,summary=summary,g=g)
    
    v<-sapply(conditions,FUN=f2,summary=summary,g=g)
    en<-entropy(v/sum(v))
    if(is.na(en))
      en<-999
    en<-tanh(en)
    mat_entropy<-matrix(rep(en,length(v)**2),length(v),length(v))
    diag(mat_entropy)<-length(conditions)
    m_Q<- 1-tanh(m_Q)
    diag(m_Q)<-length(conditions)
    v<-tanh(v)
    return(c(sum(m_Q+mat_entropy)/length(conditions)**2,sum(v)/length(conditions)))
  }
.sort_conditions <-
function(x){
    n<-names(x)
    data<-data.frame(w=x)
    data$condition<-sapply(n,FUN=function(x){str_split(x,"_")[[1]][2]})
    data$gen<-sapply(n,FUN=function(x){str_split(x,"_")[[1]][1]})
    data<-data[order(data$condition,-data$w),]
    class(data)<-"QPFS_LASSO"
    return(data)
}
